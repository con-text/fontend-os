<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/react.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/JSXTransformer.js" type="text/javascript"></script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
<script type="text/jsx">
	/** @jsx React.DOM */
	'use strict';

	if (typeof String.prototype.startsWith != 'function') {
		// see below for better implementation!
		String.prototype.startsWith = function (str){
			return this.indexOf(str) == 0;
		};
	}

	function makeUrlsAbsolute(domNode, startUrl) {
			var childNodes = domNode.childNodes;
			for(var i = 0; i < childNodes.length; i++) {
				var childNode = childNodes[i];
				if(childNode && childNode.getAttribute) {
					makeAttrAbsolute("href", childNode, startUrl);
					makeAttrAbsolute("src", childNode, startUrl);
					makeAttrAbsolute("action", childNode, startUrl);
				}

				makeUrlsAbsolute(childNode, startUrl);
			}
	}

	function addProxyToUrl(domNode) {
			var proxy = "http://localhost:5000/browser/page?url=";

			var childNodes = domNode.childNodes;

			for(var i = 0; i < childNodes.length; i++) {
				var childNode = childNodes[i];
				if(childNode && childNode.getAttribute) {
					prefixAttr("href", childNode, proxy);
					prefixAttr("action", childNode, proxy);
				}

				addProxyToUrl(childNode);
			}
	}

	function prefixAttr(attr, node, baseUrl) {
		if(node && node.getAttribute) {

			var attrValue = node.getAttribute(attr);

			if(attrValue) {
				node.setAttribute(attr, baseUrl + attrValue);
			}
		}
	}

	function makeAttrAbsolute(attr, node, baseUrl) {
		var href = node.getAttribute(attr);
		if(href && !href.startsWith("http")) {
			node.setAttribute(attr, baseUrl + href);
		}
	}

	var Browser = React.createClass({
		getInitialState: function() {
			return {
				text: '',
				url: ''
			};
		},
		componentDidMount: function() {
			$("iframe > a").click(function(e) {
				this.handleChange(e);
			});

		},
		render: function() {
			return (
				<div className="browser">
					<input value={this.state.text} onChange={this.handleChange} />
					<button onClick={this.handleClick}>Go</button>
					<div>{this.state.text}</div>
					<iframe ref="frame" width="100%" height="100%" />
				</div>
			);
		},

		handleChange: function(e) {
			this.setState({
				text: e.target.value,
				url: this.state.url
			});
		},

		handleClick: function(e) {

			var url = this.state.text.toString();
			var el = this.refs.frame.getDOMNode();

			$.get('http://localhost:5000/browser/page', {url: url}).done(function(data) {

				var doc = el.contentDocument.open('text/html');
				doc.write(data);
				doc.close();

				makeUrlsAbsolute(doc, url);
				addProxyToUrl(doc);

			});

			this.setState({
				text: url,
				url: url
			});

			e.preventDefault();
		},



	});


	// Browser.render();
	React.render(<Browser />, document.body);
	// module.exports = Browser;

</script>
