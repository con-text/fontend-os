<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/react.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/JSXTransformer.js" type="text/javascript"></script>

<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<link rel="stylesheet" href="//cdn.quilljs.com/0.19.8/quill.snow.css" />
<script src="//cdn.quilljs.com/0.19.8/quill.min.js"></script>

<script type="text/jsx">

	/** @jsx React.DOM */
	'use strict';

	var textEditor;

	function receiveTextData(data) {
		textEditor.setContents(AS._state.operations);
	}

	function receiveChangeData(data){
		textEditor.updateContents({ops:data.value});
	}

	// Collaborators pane
	var Collaborators = new React.createClass({

		getInitialState: function() {
			return {usersIds: []}
		},

		componentDidMount: function() {
			AS.on('load', this.updateUsers);
			AS.on('syncedState', this.updateUsers);
		},

		componentWillUnmount: function() {
			AS.off('load', this.updateUsers);
			AS.off('syncedState', this.updateUsers);
		},

		updateUsers: function() {
			this.setState({users: AS.collaborators});
		},

		render: function() {
			var collaborators = this.state.usersIds.map(function(userId) {
					return <span>{userId}</span>;
			}, this);

			return (
				<div id="collaborators">
					{collaborators}
				</div>
			);
		}
	});

	// Document editor class
	var Editor = React.createClass({

		/**
		* When component mounted, bind application state interefece events
		*/
		componentDidMount: function() {
			var editor = this.refs.editor.getDOMNode();

			textEditor = new Quill(editor, {
				formats: ['bold', 'italic', 'color', 'size', 'underline'],
				theme: 'snow'
			});

			textEditor.addModule('toolbar', {
				container: '#toolbar'
			});

			textEditor.on('text-change', function(delta, source) {
				if (source == 'api') {
					console.log("An API call triggered this change.");
				}
				else if (source == 'user') {
					AS.pushChange('text-change', {uuid: AS.userId, objectId: AS.objectId, action: 'changed',
							path: ["operations"], property: "operations", value: delta.ops, type: "string", OTChanges: true});
					console.log(delta.ops);
				}
			});

			AS.on('text-change', receiveChangeData);

			AS.on('syncedState', receiveTextData);
			AS.on('load', receiveTextData);
		},

		/**
		* Render the editor
		*/
		render: function() {
			return (
				<div className="editor-container">
					<div id="toolbar" className="toolbar">

						<span className="ql-format-group">
							<select title="Size" className="ql-size ql-picker">
								<option value="small">Small</option>
								<option value="normal" defaultValue>Normal</option>
								<option value="large">Large</option>
								<option value="huge">Huge</option>
							</select>
						</span>

						<span className="ql-format-group">
							<span className="ql-format-button ql-bold"></span>
							<span className="ql-format-separator"></span>
							<span className="ql-format-button ql-italic"></span>
							<span className="ql-format-separator"></span>
							<span className="ql-format-button ql-underline"></span>
						</span>
					</div>

					<div id="main">
						<div className="editor" ref="editor"></div>
						<Collaborators />
					</div>
				</div>
			);
		}
	});

	// Renender the editor
	React.render(<Editor />, document.body);

</script>
