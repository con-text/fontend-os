<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/react.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/JSXTransformer.js" type="text/javascript"></script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
<script type="text/jsx">
	/** @jsx React.DOM */
	'use strict';

	var Browser = React.createClass({

		getInitialState: function() {
			return {
				text: '',
				history: ['about:blank']
			};
		},

		componentDidMount: function() {
			var frame = this.refs.frame.getDOMNode();
			frame.setAttribute('nwdisable', '');
			frame.setAttribute('nwfaketop', '');
			frame.addEventListener("DOMAttrModified", this.handleFrameLoad);
		},

		componentWillUnmount: function() {
			var frame = this.refs.frame.getDOMNode();
			frame.removeEventListener("DOMAttrModified", this.handleFrameLoad);
		},

		render: function() {
			
			var url = this.state.history[this.state.history.length - 1];

			return (
				<div className="browser">
					<div className="address-bar">
						<button disabled={!this.canGoBack()} onClick={this.handleBackClick}>Back</button>
						<input value={this.state.text} onChange={this.handleChange} />
						<button onClick={this.handleGoClick}>Go</button>
					</div>

					<div className="web-view">
						<iframe ref="frame" src={url} width="100%" height="100%" />
					</div>
				</div>
			);
		},

		handleChange: function(e) {
			this.setState({
				text: e.target.value
			});
		},

		handleBackClick: function(e) {
			e.preventDefault();
			var frame = this.refs.frame.getDOMNode();
			// Drop current one
			this.state.history.pop();
			var url;
			if(this.state.history.length > 0) {
				url = this.state.history[this.state.history.length - 1];
			} else {
				url = "about:blank";
			}
			frame.setAttribute('src', url);
		},

		canGoBack: function() {
				this.state.history.length > 1;
		},

		handleGoClick: function(e) {
			e.preventDefault();

			var url = this.state.text.toString();
			var frame = this.refs.frame.getDOMNode();
			frame.setAttribute('src', url);
			this.setState({history: this.state.history.concat([url])});
			window.console.log(this.state.history);
		},

		handleFrameLoad: function(e) {

			console.log("Attr changed");

			if(e.attrName === "src") {
				var frame = this.refs.frame.getDOMNode();
				var url = frame.contentWindow.location.href;
				this.state.history.push(url);
				console.log("Pusing url". url);
			}
		}
	});


	// Browser.render();
	React.render(<Browser />, document.body);
	// module.exports = Browser;

</script>
